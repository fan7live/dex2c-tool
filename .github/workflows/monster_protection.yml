name: â˜¢ï¸ PROJECT MONSTER (Final Fix)

on:
  workflow_dispatch:
  push:
    paths:
      - 'input.apk'

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: â˜• Setup Java & Python
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # ØªØ«Ø¨ÙŠØª Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù„Ù„ØªØ´ÙÙŠØ±
      - name: âš™ï¸ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zipalign apksigner build-essential libssl-dev libffi-dev python3-dev

      # ======================================================
      # 1. ØªØ¬Ù‡ÙŠØ² Apktool Ù„ÙŠÙƒÙˆÙ† Ø£Ù…Ø±Ù‹Ø§ Ù†Ø¸Ø§Ù…ÙŠÙ‹Ø§ (System-Wide)
      # Ù‡Ø°Ø§ Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø£Ù† Obfuscapk ÙŠØ­Ø§ÙˆÙ„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ 'apktool' Ù…Ù† Ø§Ù„Ù€ Terminal
      # ======================================================
      - name: ğŸ› ï¸ Setup Apktool System-Wide
        run: |
          mkdir -p tools
          # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø§Ø±
          wget -q -O tools/apktool.jar https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar
          
          # Ø®Ø¯Ø¹Ø© Ø°ÙƒÙŠØ©: Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± ÙˆÙ‡Ù…ÙŠ Ù„ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
          echo '#!/bin/bash' > apktool_wrapper
          echo 'java -jar '"$GITHUB_WORKSPACE"'/tools/apktool.jar "$@"' >> apktool_wrapper
          chmod +x apktool_wrapper
          sudo mv apktool_wrapper /usr/local/bin/apktool
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† apktool ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† ÙƒØ£Ù…Ø± Ù…Ø¨Ø§Ø´Ø±
          apktool -version

      # ======================================================
      # 2. ØªØ«Ø¨ÙŠØª Obfuscapk (Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§)
      # ======================================================
      - name: ğŸ› ï¸ Install Obfuscapk (Fixed)
        run: |
          git clone https://github.com/ClaudiuGeorgiu/Obfuscapk.git obfuscapk_src
          cd obfuscapk_src
          
          # Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù…ØµØ­Ø­ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† requirements.txt)
          # ÙŠÙ‚ÙˆÙ… Ø¨Ù‚Ø±Ø§Ø¡Ø© setup.py ÙˆØªØ«Ø¨ÙŠØª ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          pip install .

      # ======================================================
      # 3. ØªØ«Ø¨ÙŠØª Dex2C (Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø­Ù…Ø§ÙŠØ© Native)
      # ======================================================
      - name: ğŸ› ï¸ Setup NDK & Dex2C
        run: |
          # Dex2c ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ Ù…Ø¹ NDK r19c
          wget -q https://dl.google.com/android/repository/android-ndk-r19c-linux-x86_64.zip
          unzip -q android-ndk-r19c-linux-x86_64.zip
          
          # ØªØ¹Ø±ÙŠÙ Ù…Ø³Ø§Ø± NDK Ù„Ù„Ù†Ø¸Ø§Ù…
          echo "NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r19c" >> $GITHUB_ENV
          
          # Ø§Ø³ØªÙ†Ø³Ø§Ø® dex2c
          git clone https://github.com/amimo/dcc.git dex2c_tool
          cd dex2c_tool
          pip install -r requirements.txt

      # ======================================================
      # 4. ØªØ´ØºÙŠÙ„ ÙˆØ­Ø´ Ø§Ù„Ø­Ù…Ø§ÙŠØ©
      # ======================================================
      - name: â˜¢ï¸ Execute PROTECTION PIPELINE
        run: |
          if [ ! -f input.apk ]; then
             echo "::error::Ù…Ù„Ù input.apk ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
             exit 1
          fi

          # Ù†Ù‚Ù„ input.apk Ù„ÙŠÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ù‹Ø§ Ù„Ù„Ø³ÙƒØ±Ø¨Øª
          cp input.apk monster_control.py

          # ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ†ØªØ±ÙˆÙ„ (ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ù‚Ù…Øª Ø¨Ø±ÙØ¹ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† Ø§Ù„Ù…Ø­Ø¯Ø« Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
          python3 monster_control.py

      - name: ğŸ“¤ Upload Protected Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MONSTER_APP_FIXED
          path: final_protected.apk
