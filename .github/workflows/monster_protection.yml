name: โข๏ธ PROJECT MONSTER (ULTIMATE FIXED)

on:
  workflow_dispatch:
  push:
    paths:
      - 'input.apk'

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: ๐ฅ Checkout Repo
        uses: actions/checkout@v4

      - name: โ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ๐ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: โ๏ธ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zipalign apksigner build-essential libssl-dev libffi-dev python3-dev

      # ======================================================
      # 1. ุชุฌููุฒ Apktool
      # ======================================================
      - name: ๐๏ธ Setup Apktool System-Wide
        run: |
          mkdir -p tools
          wget -q -O tools/apktool.jar https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar
          
          # ุฎุฏุนุฉ: ุฅูุดุงุก ุฃูุฑ ูููู ููุนูู ูู ุงููุธุงู
          echo '#!/bin/bash' > apktool_wrapper
          echo 'java -jar '"$GITHUB_WORKSPACE"'/tools/apktool.jar "$@"' >> apktool_wrapper
          chmod +x apktool_wrapper
          sudo mv apktool_wrapper /usr/local/bin/apktool
          
          # ุงูุชุฃูุฏ ูู ุงูุชุซุจูุช
          apktool -version

      # ======================================================
      # 2. ุชุซุจูุช Obfuscapk ูู ุงููุตุฏุฑ (Correct Way)
      # ======================================================
      - name: ๐๏ธ Install Obfuscapk (Source)
        run: |
          git clone https://github.com/ClaudiuGeorgiu/Obfuscapk.git obfuscapk_src
          cd obfuscapk_src
          # ุงูุชุซุจูุช ุจูุฐู ุงูุทุฑููุฉ ูุญู ูุดููุฉ requirements
          pip install .

      # ======================================================
      # 3. ุชุซุจูุช Dex2C & NDK
      # ======================================================
      - name: ๐๏ธ Setup NDK & Dex2C
        run: |
          # Dex2C needs Old NDK (r19c is best)
          wget -q https://dl.google.com/android/repository/android-ndk-r19c-linux-x86_64.zip
          unzip -q android-ndk-r19c-linux-x86_64.zip
          echo "NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r19c" >> $GITHUB_ENV
          
          git clone https://github.com/amimo/dcc.git dex2c_tool
          cd dex2c_tool
          pip install -r requirements.txt

      # ======================================================
      # 4. ุชุดุบูู ูุญุด ุงูุญูุงูุฉ (ุชู ุชุตุญูุญ ุงูุฎุทุฃ ุงููุงุชู ููุง)
      # ======================================================
      - name: โข๏ธ Execute PROTECTION PIPELINE
        run: |
          # 1. ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุชุทุจูู
          if [ ! -f input.apk ]; then
             echo "::error::ููู input.apk ุบูุฑ ููุฌูุฏ!"
             exit 1
          fi

          # 2. ุงูุชุฃูุฏ ูู ูุฌูุฏ ููุฏ ุงูุชุญูู (ุงูุจุงูุซูู)
          if [ ! -f monster_control.py ]; then
             echo "::error::ููู monster_control.py ุบูุฑ ููุฌูุฏ! ุชุฃูุฏ ูู ุฑูุนู ูููุณุชูุฏุน."
             exit 1
          fi

          # 3. ุชุนุฑูู ูุชุบูุฑ NDK ุจุดูู ุตุฑูุญ ููุฌูุณุฉ ุงูุญุงููุฉ
          export NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r19c
          
          # ุชุดุบูู ุงูุณูุฑุจุช (ุจุฏูู ูุณุฎู ููู ููุณู ุจุงูุฎุทุฃ!)
          python3 monster_control.py

      - name: ๐ค Upload Protected Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MONSTER_APP_PROTECTED
          path: final_protected.apk
