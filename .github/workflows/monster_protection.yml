name: â˜¢ï¸ PROJECT MONSTER (Final)

on:
  workflow_dispatch:
  push:
    paths:
      - 'input.apk'

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: âš™ï¸ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zipalign apksigner build-essential libssl-dev libffi-dev python3-dev

      # ======================================================
      # 1. ØªØ¬Ù‡ÙŠØ² Apktool Ù„ÙŠÙƒÙˆÙ† Ø£Ù…Ø±Ù‹Ø§ Ù†Ø¸Ø§Ù…ÙŠÙ‹Ø§
      # (Obfuscapk ÙŠØ­ØªØ§Ø¬ Ù‡Ø°Ø§ Ù„ÙƒÙŠ ÙŠØ¹Ù…Ù„)
      # ======================================================
      - name: ğŸ› ï¸ Setup Apktool System-Wide
        run: |
          mkdir -p tools
          # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø§Ø±
          wget -q -O tools/apktool.jar https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar
          
          # Ø®Ø¯Ø¹Ø©: Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± ÙˆÙ‡Ù…ÙŠ Ù„ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
          echo '#!/bin/bash' > apktool_wrapper
          echo 'java -jar '"$GITHUB_WORKSPACE"'/tools/apktool.jar "$@"' >> apktool_wrapper
          chmod +x apktool_wrapper
          sudo mv apktool_wrapper /usr/local/bin/apktool
          
          # ØªØ¬Ø±Ø¨Ø©
          apktool -version

      # ======================================================
      # 2. ØªØ«Ø¨ÙŠØª Obfuscapk Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© PIP)
      # ======================================================
      - name: ğŸ› ï¸ Install Obfuscapk (Source)
        run: |
          git clone https://github.com/ClaudiuGeorgiu/Obfuscapk.git obfuscapk_src
          cd obfuscapk_src
          pip install -r requirements.txt
          python3 setup.py install

      # ======================================================
      # 3. ØªØ«Ø¨ÙŠØª Dex2C (Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£ØµÙ„ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„ÙƒÙ† ÙØ¹Ø§Ù„)
      # ======================================================
      - name: ğŸ› ï¸ Setup NDK & Dex2C
        run: |
          # Dex2c ÙŠØ­ØªØ§Ø¬ NDK Ù‚Ø¯ÙŠÙ… Ù†ÙˆØ¹Ø§Ù‹ Ù…Ø§ Ù„ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ ØªØ¹Ù‚ÙŠØ¯
          wget -q https://dl.google.com/android/repository/android-ndk-r19c-linux-x86_64.zip
          unzip -q android-ndk-r19c-linux-x86_64.zip
          echo "NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r19c" >> $GITHUB_ENV
          
          # Ø§Ø³ØªÙ†Ø³Ø§Ø® dex2c
          git clone https://github.com/amimo/dcc.git dex2c_tool
          cd dex2c_tool
          pip install -r requirements.txt

      # ======================================================
      # 4. ØªØ´ØºÙŠÙ„ ÙˆØ­Ø´ Ø§Ù„Ø­Ù…Ø§ÙŠØ©
      # ======================================================
      - name: â˜¢ï¸ Execute PROTECTION PIPELINE
        run: |
          if [ ! -f input.apk ]; then
             echo "::error::Ù…Ù„Ù input.apk ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
             exit 1
          fi

          # Ù†Ø³ØªØ®Ø¯Ù… Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù€ ndk Ù„Ù„Ø³ÙƒØ±ÙŠØ¨Øª
          export NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r19c
          
          # Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
          cp input.apk monster_control.py
          python3 monster_control.py

      - name: ğŸ“¤ Upload Protected Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MONSTER_APP_V2
          path: final_protected.apk
