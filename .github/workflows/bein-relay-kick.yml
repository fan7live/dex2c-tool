name: Pro Relay - Bein Sports 1

on:
  workflow_dispatch:

env:
  # ضع رابط RTMP الخاص بك هنا
  RTMP_FULL: rtmps://fa723fc1b171.global-contribute.live-video.net:443/app/sk_us-west-2_nU83ZTW6D6Tu_wFPkEaWWRcqhLm7inTHXfkGv4SrMy9
  # رابط القناة
  M3U8_URL: http://affinderot.org:8080/bn1hevc/index.m3u8
  # رابط الشعار الجديد
  LOGO_URL: https://image.fanlive.org//upload/fanliveonly.png

jobs:
  stream_relay:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # تقريباً 6 ساعات

    steps:
      - name: Setup FFmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget xz-utils
          # تحميل أحدث نسخة مستقرة وخفيفة
          wget -q https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar xf ffmpeg-master-latest-linux64-gpl.tar.xz
          sudo mv ffmpeg-master-latest-linux64-gpl/bin/ffmpeg /usr/local/bin/ffmpeg
          sudo chmod +x /usr/local/bin/ffmpeg
          rm -rf ffmpeg*

      - name: Fetch Logo
        run: wget -O /tmp/logo.png "${{ env.LOGO_URL }}"

      - name: Start Professional Stream
        run: |
          # التعديلات الاحترافية:
          # -preset ultrafast: أسرع أداء ممكن لتقليل الضغط
          # -c:a copy: نسخ الصوت دون تعديل لتوفير الموارد
          # scale2ref: يجعل حجم اللوجو يطابق حجم الفيديو الأصلي بالضبط
          
          ffmpeg -hide_banner -loglevel error \
            -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 -reconnect_delay_max 20 \
            -thread_queue_size 1024 -i "${{ env.M3U8_URL }}" \
            -thread_queue_size 1024 -loop 1 -i /tmp/logo.png \
            -filter_complex "[1:v][0:v]scale2ref=iw:ih[logo][video];[video][logo]overlay=0:0[outv]" \
            -map "[outv]" -map 0:a \
            -c:v libx264 -preset ultrafast -tune zerolatency \
            -maxrate 6000k -bufsize 12000k \
            -pix_fmt yuv420p -g 50 -r 25 \
            -c:a copy \
            -f flv "${{ env.RTMP_FULL }}"
