name: 1080p High Performance Stream (Fix IPTV)

on:
  workflow_dispatch:
    inputs:
      stream_source:
        description: 'أدخل رابط البث (Link)'
        required: true
        default: 'http://mac12546.cdngold.me/live/7e93f942fd00/a1d06bbaed/544451.m3u8'
        type: string
      stream_key:
        description: 'أدخل مفتاح البث (Key)'
        required: true
        type: string

env:
  RTMP_SERVER: "rtmps://fa723fc1b171.global-contribute.live-video.net:443/app/"

jobs:
  stream_1080:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Setup FFmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget
          wget -q https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar xf ffmpeg-master-latest-linux64-gpl.tar.xz
          sudo mv ffmpeg-master-latest-linux64-gpl/bin/ffmpeg /usr/local/bin/ffmpeg
          chmod +x /usr/local/bin/ffmpeg

      - name: Prepare Stream Info
        id: info
        run: echo "::add-mask::${{ github.event.inputs.stream_key }}"

      - name: Start Stream (Anti-Ban & Audio Fix)
        run: |
          echo "Processing Stream with Smart Headers..."
          RTMP_FINAL="${{ env.RTMP_SERVER }}${{ github.event.inputs.stream_key }}"
          
          # التغييرات لحل المشكلة:
          # -user_agent: خداع السيرفر بأننا متصفح لفك الحظر
          # -c:a aac: إعادة تشفير الصوت لضمان قبوله (بدلاً من copy التي تفشل مع IPTV)
          # -err_detect ignore_err: لتجاهل الأخطاء البسيطة في البث المصدر
          
          ffmpeg -hide_banner -loglevel warning \
            -user_agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" \
            -headers "Referer: https://www.google.com/" \
            -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 -reconnect_delay_max 5 \
            -thread_queue_size 2048 \
            -i "${{ github.event.inputs.stream_source }}" \
            -map 0:v -map 0:a \
            -c:v libx264 -preset ultrafast -tune zerolatency \
            -b:v 4500k -maxrate 4500k -bufsize 9000k \
            -r 30 -g 60 -keyint_min 60 -sc_threshold 0 \
            -pix_fmt yuv420p \
            -c:a aac -ar 44100 -b:a 128k \
            -f flv \
            -max_muxing_queue_size 4096 \
            -err_detect ignore_err \
            "$RTMP_FINAL"
