name: 1080p High Performance Stream (Custom Input)

on:
  workflow_dispatch:
    inputs:
      stream_source:
        description: 'أدخل رابط البث المراد إعادة بثه (M3U8 / URL)'
        required: true
        default: 'http://affinderot.org:8080/bn1hevc/index.m3u8'
        type: string
      stream_key:
        description: 'أدخل مفتاح البث فقط (مثال: sk_us-west...)'
        required: true
        type: string

env:
  # رابط السيرفر الثابت كما طلبت
  RTMP_SERVER: "rtmps://fa723fc1b171.global-contribute.live-video.net:443/app/"

jobs:
  stream_1080:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # مدة البث 6 ساعات

    steps:
      - name: Setup FFmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget
          # تحميل وتركيب FFmpeg النسخة الأصلية للأداء المستقر
          wget -q https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar xf ffmpeg-master-latest-linux64-gpl.tar.xz
          sudo mv ffmpeg-master-latest-linux64-gpl/bin/ffmpeg /usr/local/bin/ffmpeg
          chmod +x /usr/local/bin/ffmpeg

      - name: Prepare Stream Info
        id: info
        run: |
          # إخفاء المفتاح من سجلات التشغيل للحماية
          echo "::add-mask::${{ github.event.inputs.stream_key }}"

      - name: Start 1080p Stream (High Performance)
        run: |
          echo "Starting Stream Processing..."
          
          # تجميع الرابط النهائي (السيرفر الثابت + المفتاح المدخل)
          RTMP_FINAL="${{ env.RTMP_SERVER }}${{ github.event.inputs.stream_key }}"

          # إعدادات FFmpeg للأداء العالي وتفادي اللاغ
          # -r 30: تثبيت الإطارات
          # -tune zerolatency: لتقليل التأخير
          # -preset ultrafast: لتخفيف الضغط عن المعالج

          ffmpeg -hide_banner -loglevel error \
            -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 -reconnect_delay_max 5 \
            -thread_queue_size 2048 \
            -i "${{ github.event.inputs.stream_source }}" \
            -map 0:v -map 0:a \
            -c:v libx264 -preset ultrafast -tune zerolatency \
            -b:v 4500k -maxrate 4500k -bufsize 9000k \
            -r 30 -g 60 -keyint_min 60 -sc_threshold 0 \
            -pix_fmt yuv420p \
            -c:a copy \
            -f flv \
            -max_muxing_queue_size 4096 \
            "$RTMP_FINAL"
