name: 1080p High Performance Stream

on:
  workflow_dispatch:

env:
  RTMP_FULL: rtmps://fa723fc1b171.global-contribute.live-video.net:443/app/sk_us-west-2_nU83ZTW6D6Tu_wFPkEaWWRcqhLm7inTHXfkGv4SrMy9
  M3U8_URL: http://affinderot.org:8080/bn1hevc/index.m3u8

jobs:
  stream_1080:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # مدة البث 6 ساعات

    steps:
      - name: Setup FFmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget
          # نستخدم النسخة الأصلية للأداء المستقر
          wget -q https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar xf ffmpeg-master-latest-linux64-gpl.tar.xz
          sudo mv ffmpeg-master-latest-linux64-gpl/bin/ffmpeg /usr/local/bin/ffmpeg
          chmod +x /usr/local/bin/ffmpeg

      - name: Start 1080p Stream (High Performance)
        run: |
          # التعديلات الحرجة لتشغيل 1080p بدون لاغ:
          # -r 30: تثبيت الإطارات على 30 لتقليل ضغط المعالج للنصف
          # -c:a copy: نسخ الصوت لتوفير الموارد
          # -max_muxing_queue_size 4096: لمنع رسائل buffer underflow
          # -preset ultrafast: الأولوية للسرعة المطلقة
          
          ffmpeg -hide_banner -loglevel warning \
            -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 -reconnect_delay_max 5 \
            -thread_queue_size 2048 \
            -i "${{ env.M3U8_URL }}" \
            -map 0:v -map 0:a \
            -c:v libx264 -preset ultrafast -tune zerolatency \
            -b:v 4500k -maxrate 4500k -bufsize 9000k \
            -r 30 -g 60 -keyint_min 60 -sc_threshold 0 \
            -pix_fmt yuv420p \
            -c:a copy \
            -f flv \
            -max_muxing_queue_size 4096 \
            "${{ env.RTMP_FULL }}"
