name: Ultimate Bypass Stream (VLC Mimic)

on:
  workflow_dispatch:

env:
  RTMP_FULL: rtmps://fa723fc1b171.global-contribute.live-video.net:443/app/sk_us-west-2_nU83ZTW6D6Tu_wFPkEaWWRcqhLm7inTHXfkGv4SrMy9
  M3U8_URL: http://mac12546.cdngold.me/live/7e93f942fd00/a1d06bbaed/544451.m3u8

jobs:
  bypass_stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget
          wget -q https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar xf ffmpeg-master-latest-linux64-gpl.tar.xz
          sudo mv ffmpeg-master-latest-linux64-gpl/bin/ffmpeg /usr/local/bin/ffmpeg
          chmod +x /usr/local/bin/ffmpeg

      - name: Start VLC Mimic Stream
        run: |
          # 1. انتحال شخصية VLC لتخطي الحماية 458
          # 2. استخدام -c copy للخفة القصوى
          # 3. إزالة Headers المعقدة لتفادي خطأ CRLF السابق
          
          ffmpeg -hide_banner -loglevel warning \
            -user_agent "VLC/3.0.18 LibVLC/3.0.18" \
            -reconnect 1 -reconnect_streamed 1 -reconnect_at_eof 1 -reconnect_delay_max 5 \
            -i "${{ env.M3U8_URL }}" \
            -c copy \
            -bsf:a aac_adtstoasc \
            -f flv "${{ env.RTMP_FULL }}"
