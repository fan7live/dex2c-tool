name: Dex2C Protect Full APK

on:
  workflow_dispatch:
    inputs:
      classes_or_packages:
        description: 'Classes or packages (comma separated)'
        required: true
        default: ''

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y unzip zip openjdk-11-jdk python3 python3-pip cmake clang make

      - name: Verify input APK
        run: |
          if [ ! -f "input.apk" ]; then
            echo "::error::input.apk NOT FOUND"
            exit 1
          fi

      - name: Prepare dex2c
        run: |
          chmod +x dex2c.sh

      - name: Run dex2c
        run: |
          ./dex2c.sh input.apk "${{ github.event.inputs.classes_or_packages }}"

      - name: Verify output lib
        run: |
          if [ ! -f "libstub.so" ]; then
            echo "::error::libstub.so not generated"
            exit 1
          fi

      - name: Strip symbols
        run: |
          strip --strip-all libstub.so

      - name: Simple ELF hardening
        run: |
          echo "Hardening ELF"
          chmod 000 libstub.so
          chmod 644 libstub.so

      - name: Upload protected lib
        uses: actions/upload-artifact@v4
        with:
          name: protected-lib
          path: libstub.so
