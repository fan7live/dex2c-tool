name: Dex2C Protect Full APK

on:
  workflow_dispatch:
    inputs:
      classes_or_packages:
        description: 'Enter classes or packages to protect (comma-separated, e.g., com/fan/live/tv/android/Api,com/other/Class or com/fan/live/tv/android/ for all classes in package)'
        required: true
        default: ''

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3 python3-pip \
          openjdk-11-jdk \
          git unzip \
          clang cmake make \
          lib32z1 \
          zipalign apksigner \
          llvm lld  # For OLLVM and advanced protections
        # Install additional dependencies for LLVM build
        sudo apt-get install -y libstdc++-12-dev zlib1g-dev libncurses5-dev libxml2-dev libedit-dev python3-sphinx

    - name: Setup Android NDK r21e
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
        unzip -q android-ndk-r21e-linux-x86_64.zip
        echo "NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-r21e" >> $GITHUB_ENV
        echo "PATH=$PATH:$GITHUB_WORKSPACE/android-ndk-r21e" >> $GITHUB_ENV

    - name: Setup OLLVM (Obfuscator-LLVM) for Advanced Protection
      run: |
        git clone https://github.com/obfuscator-llvm/obfuscator.git --branch llvm-4.0
        cd obfuscator
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_PROJECTS=clang ..
        make -j$(nproc)
        echo "OLLVM_BIN=$GITHUB_WORKSPACE/obfuscator/build/bin" >> $GITHUB_ENV
        echo "PATH=$PATH:$GITHUB_WORKSPACE/obfuscator/build/bin" >> $GITHUB_ENV

    - name: Setup Dex2C
      run: |
        git clone https://github.com/codehasan/dex2c.git
        cd dex2c
        pip3 install -r requirements.txt
        mkdir -p tools
        wget -q -O tools/apktool.jar \
          https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar
        sed -i "s|ndk_dir = .*|ndk_dir = $GITHUB_WORKSPACE/android-ndk-r21e|" dcc.cfg

    - name: Extract Classes from APK if Packages Specified
      run: |
        if [ ! -f "input.apk" ]; then
          echo "::error::input.apk NOT FOUND"
          exit 1
        fi

        # Decompile APK using Apktool to extract class list
        java -jar dex2c/tools/apktool.jar d -f -s input.apk -o decompiled

        # Function to get classes from package
        get_classes_from_package() {
          PACKAGE=$1
          PACKAGE_PATH=$(echo $PACKAGE | sed 's/\./\//g')
          find decompiled/smali*/$PACKAGE_PATH -type f -name "*.smali" 2>/dev/null | \
          sed "s|decompiled/smali.*/||; s|/|.|g; s|\.smali$||"
        }

        # Parse inputs
        IFS=',' read -ra INPUTS <<< "${{ inputs.classes_or_packages }}"

        CLASSES=()
        for INPUT in "${INPUTS[@]}"; do
          if [[ "$INPUT" == */ ]]; then
            # It's a package, extract all classes
            PACKAGE=${INPUT%/}
            PACKAGE_CLASSES=$(get_classes_from_package "$PACKAGE")
            CLASSES+=($PACKAGE_CLASSES)
          else
            # It's a specific class
            CLASSES+=("$INPUT")
          fi
        done

        # Remove duplicates and save to a file for later use
        printf "%s\n" "${CLASSES[@]}" | sort -u > classes_to_protect.txt

        echo "Classes to protect:"
        cat classes_to_protect.txt

    - name: Prepare Filter for Protection
      run: |
        cd dex2c
        echo "=== Setting up filter.txt for protection ==="
        
        # Generate whitelist based on extracted classes
        > filter.txt  # Empty file
        while IFS= read -r CLASS; do
          if [ -n "$CLASS" ]; then
            echo "$CLASS;.*  # Protect all methods in this class" >> filter.txt
          fi
        done < ../classes_to_protect.txt
        
        # Add blacklist for exclusions
        cat << EOF >> filter.txt
        
        # Blacklist for exclusions (add here if errors in logs)
        !.*;<init>\(.*\)  # Exclude constructors
        !.*;<clinit>\(.*\) # Exclude static initializers
        !android/.*;.*  # Exclude Android SDK classes
        !java/.*;.*     # Exclude Java standard classes
        !androidx/.*;.* # Exclude AndroidX classes (common exclusion)
        !kotlin/.*;.*   # Exclude Kotlin stdlib (if needed)
        EOF
        
        echo "Filter setup complete:"
        cat filter.txt

    - name: Run Dex2C on Full APK with Advanced Protections
      run: |
        if [ ! -f "input.apk" ]; then
          echo "::error::input.apk NOT FOUND"
          exit 1
        fi

        cp input.apk dex2c/input.apk
        cd dex2c

        echo "=== Protecting FULL APK with Advanced Obfuscation ==="

        # To use OLLVM in Dex2C: Override the compiler in ndk-build
        # Dex2C generates Android.mk, so we run dcc.py first, then modify Android.mk, then build
        python3 dcc.py -a input.apk -o protected.apk --no-build  # Run without building to generate files

        # Now modify the generated Android.mk to use OLLVM clang
        if [ -f "jni/Android.mk" ]; then
          sed -i 's|LOCAL_CC := \( (NDK_TOOLCHAIN_PATH)/clang|LOCAL_CC := \){{ env.OLLVM_BIN }}/clang|' jni/Android.mk
          sed -i 's|LOCAL_CXX := \( (NDK_TOOLCHAIN_PATH)/clang++|LOCAL_CXX := \){{ env.OLLVM_BIN }}/clang++|' jni/Android.mk
          # Add OLLVM flags for obfuscation
          echo "LOCAL_CFLAGS += -mllvm -fla -mllvm -bcf -mllvm -sub" >> jni/Android.mk
          
          # Now build with ndk-build using modified Android.mk
          $NDK_ROOT/ndk-build -C jni
          
          # Continue with Dex2C's post-build steps if needed (repack APK)
          python3 dcc.py -a input.apk -o protected.apk --only-build  # Assuming Dex2C supports only-build, or manual repack
        else
          python3 dcc.py -a input.apk -o protected.apk  # Fallback
        fi
        
        # Re-sign and align the APK
        zipalign -v -p 4 protected.apk aligned.apk
        apksigner sign --ks ~/.android/debug.keystore --ks-pass pass:android aligned.apk --v1-signing-enabled --v2-signing-enabled
        mv aligned.apk protected.apk

        echo "=== Verification ==="
        if [ -f "protected.apk" ]; then
          echo "SUCCESS: protected.apk created with advanced protections"
          ls -lh protected.apk
        else
          echo "::error::FAILED: No protected.apk generated"
          exit 1
        fi

    - name: Upload Protected APK
      uses: actions/upload-artifact@v4
      with:
        name: protected-apk
        path: dex2c/protected.apk
